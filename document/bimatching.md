[TOC]

# Bipartite Matching

二部グラフの最大マッチング問題を解くライブラリです．グラフ $G = (V, E)$ のマッチングとは，辺部分集合 $M \subset E$ で $M$ のどの $2$ 辺も同じ頂点に接続しないもののことです．最大マッチングとは，$M$ のうち要素数が最大のもののことです．

## コンストラクタ

```cpp
BiMatching graph(int n, int m)
```

`n` 頂点の集合 $A$ と `m` 頂点の集合 $B$ からなる二部グラフ $G$ を作ります．最初，辺数は $0$ です．

**制約**

- $0 \leq n, m \leq 10^8$

**計算量**

- $O(n+m)$

## add_edge

```cpp
void graph.add_edge(int u, int v)
```

$A$ の頂点 `u` と $B$ の頂点 `v` を結ぶ辺を追加します．

**制約**

- $0 \leq u \lt n$
- $0 \leq v < m$

**計算量**

- $O(1)$

## solve

```cpp
int graph.solve()
```

二部グラフ $G$ の最大マッチングの要素数を返します．グラフは最大マッチングのうちいずれか $1$ つを辺集合とするグラフに変化します．この関数は $1$ つのグラフに対して  $1$ 回しか呼べません．

**計算量**

$E$ を追加された辺集合として

- $O((n + |E|) \sqrt{n})$

## pair_right

```cpp
int graph.pair_right(int u)
```

集合 $A$ の頂点 `u` のペアとなった集合 $B$ の頂点の番号を返します．ペアの相手が存在しない場合，`-1` を返します．返り値 `v` は `-1` または $0 \leq v < m$ です．

**制約**

- $0 \leq u \lt n$

**計算量**

- $O(1)$

## pair_left

```cpp
int graph.pair_left(int v)
```

集合 $B$ の頂点 `v` のペアとなった集合 $A$ の頂点の番号を返します．ペアの相手が存在しない場合，`-1` を返します．返り値 `u` は `-1` または $0 \leq u < n$ です．

**制約**

- $0 \leq v < m$

**計算量**

- $O(1)$

## private変数，private関数

```cpp
int _n
int _m
vector<vector<int>> g
vector<int> d
```

- `_n` : 集合 $A$ の頂点数
- `_m` : 集合 $B$ の頂点数
- `g` : `g[i]` は集合 $A$ の頂点 `i` と結ばれている集合 $B$ の頂点の番号の配列
- `d` : ペアの相手をメモしておく配列

## 二部マッチングの計算量について

[Hopcroft-Karpのアルゴリズム](http://dopal.cs.uec.ac.jp/okamotoy/lect/2020/matching/handout03.pdf)を用いて実装しています．頂点集合を $V$，辺集合を $E (|E| > |V|)$ として計算量は $O(|E| \sqrt{|V|})$ です．リンク先に詳しい説明ありますが，要約すると以下のようになります．

頂点集合 $A, B$ からなる二部グラフ $G$ に対して以下のステップを繰り返します．

- (1) BFSにより，$A$ の頂点のうち，まだペアの相手がいないものに対してそれぞれを始点とする最短増加パスを探します．増加パスとは，マッチング $M$ に含まない辺と含まれる辺を交互に繋いだパスのうち，両端の点が $M$ の辺と接続しないもののことです．増加パスが見つからなければこれ以上ペアの数を増やせないので終了します．計算量は $O(|E|)$ です．内部実装では `level` に始点からの最短距離をメモしています．

- (2) DFSにより，(1) で見つけたぞれぞれの増加パス $P$ に対して $M \leftarrow M \triangle P$ という操作を行います．$\triangle$ は対称差を取る記号です．この操作によりペアの数が $1$ ずつ増加します．$1$ 回増加パスに使われた頂点は同じステップ内で以後使わないようにします．内部実装では `used` に頂点を使ったかをメモしています．計算量は $O(|E|)$ です．

ステップの反復回数を考えます．最大マッチングの要素数を $\mu$ とし，
$$
M_0 = \empty, {\ } M_1 = M_0 \triangle P_0, \ldots , {\ } M_{\mu} = M_{\mu-1} \triangle P_{\mu-1}
$$
のようにして最大マッチング $M_{\mu}$ を求めることを考えます．各ステップで用いる増加パスは頂点を共有しないことから，$|P_0| \leq |P_1| \leq \ldots \leq |P_{\mu-1}|$ としても一般性を失いません．このとき，ステップ数が $O(\sqrt{|V|})$ になることを示すために，以下の補題を準備します．

- (a) $P_0, P_1 \ldots , P_{\mu-1}$ の中で長さが同じものは頂点を共有しない．
- (b) $M_i \triangle M_j {\ } (i < j)$ には $M_i$ に関する増加パスが少なくとも $|M_j| - |M_i|$ 個存在し，それらは頂点を共有しない．

補題の証明は省略します．補題 (a) より，$1$ つのステップで同じ長さの増加パスをすべて処理することができます．BFSでは最短増加パスを探すので，ステップごとに最短増加パスの長さが真に増加することがわかります．次に $M_{\lfloor \mu - \sqrt{\mu} \rfloor}$ を考えます．補題 (b) より，$M_{\lfloor \mu - \sqrt{\mu} \rfloor}$ に関する増加パスで頂点を共有しないものが $\mu - \lfloor \mu - \sqrt{\mu} \rfloor$ 個以上存在します．このことから， $M_{\lfloor \mu - \sqrt{\mu} \rfloor}$ に関する最短増加パスの長さは
$$
|P_{\lfloor \mu - \sqrt{\mu} \rfloor}| \leq 2 \frac{\lfloor \mu - \sqrt{\mu} \rfloor}{\mu - \lfloor \mu - \sqrt{\mu} \rfloor} + 1
$$
となります．$\mu$ は高々 $\lfloor |V| / 2 \rfloor$ なので ，$M_{\lfloor \mu - \sqrt{\mu} \rfloor}$ が見つかるまでのステップ数は $O(\sqrt{|V|})$ です．また，$M_{\lfloor \mu - \sqrt{\mu} \rfloor}$ が見つかってから $M_{\mu}$ が見つかるまでのステップ数は高々$\mu - \lfloor \mu - \sqrt{\mu} \rfloor$ なので $O(\sqrt{|V|})$ です．よって全体のステップ数は $O(\sqrt{|V|})$ です．

以上より，Hopcroft-Karpのアルゴリズムの計算量は $O(|E| \sqrt{|V|})$ であることがわかりました．